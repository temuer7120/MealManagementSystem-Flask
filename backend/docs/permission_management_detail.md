# 权限管理详细说明

## 1. 权限体系概述

餐食管理系统采用基于角色的权限控制（RBAC）模型，通过角色分配不同的操作权限，确保不同权限的用户只能访问和操作其权限范围内的功能和数据。

## 2. 角色定义

系统包含以下角色：

| 角色 | 描述 | 权限级别 |
|------|------|----------|
| admin | 管理员 | 最高权限，拥有所有功能的访问和操作权限 |
| nutritionist | 营养师 | 负责菜品和菜单管理 |
| chef | 厨师 | 负责食材和菜品管理 |
| admin_staff | 行政人员 | 负责客户和订单管理 |
| head_nurse | 护士长 | 负责客户管理 |
| nurse | 护士 | 负责客户管理 |
| caregiver | 护理员 | 负责客户管理 |
| customer | 客户 | 只能查看与自己相关的信息 |
| guest | 访客 | 只能查看公开信息 |

## 3. 功能权限矩阵

### 3.1 菜单权限

| 菜单项 | admin | nutritionist | chef | admin_staff | head_nurse | nurse | caregiver | customer | guest |
|--------|-------|-------------|------|-------------|------------|-------|-----------|----------|-------|
| 系统管理 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 用户管理 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 食材管理 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 菜品管理 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 菜单管理 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 客户管理 | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 订单管理 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 排餐管理 | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 报表中心 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 个人中心 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |

### 3.2 操作权限

| 操作 | admin | nutritionist | chef | admin_staff | head_nurse | nurse | caregiver | customer | guest |
|------|-------|-------------|------|-------------|------------|-------|-----------|----------|-------|
| 创建用户 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 修改用户 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除用户 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建食材 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 修改食材 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除食材 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建菜品 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 修改菜品 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除菜品 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建菜单 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 修改菜单 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除菜单 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建客户 | ✅ | ❌ | ❌ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 修改客户 | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 删除客户 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建订单 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 修改订单 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 删除订单 | ✅ | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 创建排餐 | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 修改排餐 | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 删除排餐 | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 上传Excel | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 查看报表 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ |
| 修改个人信息 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |
| 修改密码 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ |

## 3. 数据访问权限

### 3.1 食材数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有食材 | 所有食材的增删改查 |
| nutritionist | 所有食材 | 所有食材的增删改查 |
| chef | 所有食材 | 所有食材的增删改查 |
| admin_staff | 所有食材 | 只能查看，不能修改 |
| head_nurse | 所有食材 | 只能查看，不能修改 |
| nurse | 所有食材 | 只能查看，不能修改 |
| caregiver | 所有食材 | 只能查看，不能修改 |
| customer | 所有食材 | 只能查看，不能修改 |
| guest | 所有食材 | 只能查看，不能修改 |

### 3.2 菜品数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有菜品 | 所有菜品的增删改查 |
| nutritionist | 所有菜品 | 所有菜品的增删改查 |
| chef | 所有菜品 | 所有菜品的增删改查 |
| admin_staff | 所有菜品 | 只能查看，不能修改 |
| head_nurse | 所有菜品 | 只能查看，不能修改 |
| nurse | 所有菜品 | 只能查看，不能修改 |
| caregiver | 所有菜品 | 只能查看，不能修改 |
| customer | 所有菜品 | 只能查看，不能修改 |
| guest | 所有菜品 | 只能查看，不能修改 |

### 3.3 菜单数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有菜单 | 所有菜单的增删改查 |
| nutritionist | 所有菜单 | 所有菜单的增删改查 |
| chef | 所有菜单 | 所有菜单的增删改查 |
| admin_staff | 所有菜单 | 只能查看，不能修改 |
| head_nurse | 所有菜单 | 只能查看，不能修改 |
| nurse | 所有菜单 | 只能查看，不能修改 |
| caregiver | 所有菜单 | 只能查看，不能修改 |
| customer | 所有菜单 | 只能查看，不能修改 |
| guest | 所有菜单 | 只能查看，不能修改 |

### 3.4 客户数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有客户 | 所有客户的增删改查 |
| nutritionist | 所有客户 | 只能查看和修改，不能删除 |
| chef | 所有客户 | 只能查看，不能修改和删除 |
| admin_staff | 所有客户 | 所有客户的增删改查 |
| head_nurse | 所有客户 | 只能查看和修改，不能删除 |
| nurse | 所有客户 | 只能查看和修改，不能删除 |
| caregiver | 所有客户 | 只能查看和修改，不能删除 |
| customer | 只能查看自己 | 只能查看和修改自己的信息 |
| guest | 无 | 无 |

### 3.5 订单数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有订单 | 所有订单的增删改查 |
| nutritionist | 所有订单 | 只能查看，不能修改和删除 |
| chef | 所有订单 | 只能查看，不能修改和删除 |
| admin_staff | 所有订单 | 所有订单的增删改查 |
| head_nurse | 所有订单 | 只能查看，不能修改和删除 |
| nurse | 所有订单 | 只能查看，不能修改和删除 |
| caregiver | 所有订单 | 只能查看，不能修改和删除 |
| customer | 只能查看自己的订单 | 只能查看，不能修改和删除 |
| guest | 无 | 无 |

### 3.6 排餐数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有排餐 | 所有排餐的增删改查 |
| nutritionist | 所有排餐 | 所有排餐的增删改查 |
| chef | 所有排餐 | 所有排餐的增删改查 |
| admin_staff | 所有排餐 | 只能查看，不能修改和删除 |
| head_nurse | 所有排餐 | 只能查看和修改，不能删除 |
| nurse | 所有排餐 | 只能查看和修改，不能删除 |
| caregiver | 所有排餐 | 只能查看和修改，不能删除 |
| customer | 只能查看自己的排餐 | 只能查看，不能修改和删除 |
| guest | 无 | 无 |

### 3.7 报表数据
| 权限 | 可访问范围 | 可操作范围 |
|------|------------|------------|
| admin | 所有报表 | 所有报表的查看和生成 |
| nutritionist | 所有报表 | 所有报表的查看和生成 |
| chef | 所有报表 | 所有报表的查看和生成 |
| admin_staff | 所有报表 | 所有报表的查看和生成 |
| head_nurse | 所有报表 | 所有报表的查看和生成 |
| nurse | 所有报表 | 只能查看，不能生成 |
| caregiver | 所有报表 | 只能查看，不能生成 |
| customer | 只能查看自己的报表 | 只能查看，不能生成 |
| guest | 无 | 无 |

## 4. 前端菜单项控制

### 4.1 管理员菜单
```
- 系统管理
  - 用户管理
  - 角色管理
  - 权限设置
- 食材管理
  - 食材列表
  - 食材入库
  - 库存预警
- 菜品管理
  - 菜品列表
  - 菜品分类
  - 食材组成
- 菜单管理
  - 基础菜单
  - 每日菜单
  - 菜单模板
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 订单管理
  - 订单列表
  - 订单详情
  - 订单统计
- 排餐管理
  - 排餐表
  - 排餐详情
  - 状态跟踪
- 报表中心
  - 食材报表
  - 菜品报表
  - 订单报表
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.2 营养师菜单
```
- 食材管理
  - 食材列表
- 菜品管理
  - 菜品列表
  - 菜品分类
  - 食材组成
- 菜单管理
  - 基础菜单
  - 每日菜单
  - 菜单模板
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 排餐管理
  - 排餐表
  - 排餐详情
  - 状态跟踪
- 报表中心
  - 食材报表
  - 菜品报表
  - 订单报表
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.3 厨师菜单
```
- 食材管理
  - 食材列表
  - 食材入库
  - 库存预警
- 菜品管理
  - 菜品列表
  - 菜品分类
  - 食材组成
- 菜单管理
  - 基础菜单
  - 每日菜单
- 排餐管理
  - 排餐表
  - 排餐详情
- 报表中心
  - 食材报表
  - 菜品报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.4 行政人员菜单
```
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 订单管理
  - 订单列表
  - 订单详情
  - 订单统计
- 报表中心
  - 订单报表
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.5 护士长菜单
```
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 排餐管理
  - 排餐表
  - 排餐详情
  - 状态跟踪
- 报表中心
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.6 护士菜单
```
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 排餐管理
  - 排餐表
  - 排餐详情
  - 状态跟踪
- 报表中心
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.7 护理员菜单
```
- 客户管理
  - 客户列表
  - 客户详情
  - 饮食禁忌
- 排餐管理
  - 排餐表
  - 排餐详情
  - 状态跟踪
- 报表中心
  - 客户报表
- 个人中心
  - 个人信息
  - 修改密码
```

### 4.8 客户菜单
```
- 菜单管理
  - 基础菜单
  - 每日菜单
- 个人中心
  - 个人信息
  - 修改密码
  - 我的订单
  - 我的排餐
```

### 4.9 访客菜单
```
- 菜单管理
  - 基础菜单
  - 每日菜单
- 个人中心
  - 登录/注册
```

## 5. API接口权限控制

### 5.1 认证接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/auth/register | POST | 无 |
| /api/auth/login | POST | 无 |
| /api/auth/me | GET | 所有登录用户 |
| /api/auth/refresh | POST | 所有登录用户 |

### 5.2 食材接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/ingredients | GET | 所有用户 |
| /api/ingredients | POST | admin, nutritionist, chef |
| /api/ingredients/<id> | GET | 所有用户 |
| /api/ingredients/<id> | PUT | admin, nutritionist, chef |
| /api/ingredients/<id> | DELETE | admin, nutritionist, chef |

### 5.3 菜品接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/dishes | GET | 所有用户 |
| /api/dishes | POST | admin, nutritionist, chef |
| /api/dishes/<id> | GET | 所有用户 |
| /api/dishes/<id> | PUT | admin, nutritionist, chef |
| /api/dishes/<id> | DELETE | admin, nutritionist, chef |
| /api/dishes/<id>/ingredients | GET | 所有用户 |
| /api/dishes/<id>/ingredients | POST | admin, nutritionist, chef |

### 5.4 菜单接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/menus | GET | 所有用户 |
| /api/menus | POST | admin, nutritionist, chef |
| /api/menus/<id> | GET | 所有用户 |
| /api/menus/<id> | PUT | admin, nutritionist, chef |
| /api/menus/<id> | DELETE | admin, nutritionist, chef |
| /api/daily_menus | GET | 所有用户 |
| /api/daily_menus/<id> | GET | 所有用户 |

### 5.5 客户接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/customers | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver |
| /api/customers | POST | admin, admin_staff, head_nurse, nurse, caregiver |
| /api/customers/<id> | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver, customer(只能查看自己) |
| /api/customers/<id> | PUT | admin, nutritionist, admin_staff, head_nurse, nurse, caregiver, customer(只能修改自己) |
| /api/customers/<id> | DELETE | admin, admin_staff |

### 5.6 订单接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/orders | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver |
| /api/orders | POST | admin, admin_staff |
| /api/orders/<id> | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver, customer(只能查看自己的) |
| /api/orders/<id> | PUT | admin, admin_staff |
| /api/orders/<id> | DELETE | admin, admin_staff |

### 5.7 排餐接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/meal_schedules | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver |
| /api/meal_schedules | POST | admin, nutritionist, chef, head_nurse, nurse, caregiver |
| /api/meal_schedules/<id> | GET | admin, nutritionist, chef, admin_staff, head_nurse, nurse, caregiver, customer(只能查看自己的) |
| /api/meal_schedules/<id> | PUT | admin, nutritionist, chef, head_nurse, nurse, caregiver |
| /api/meal_schedules/<id> | DELETE | admin, nutritionist, chef |
| /api/meal_schedules/<id>/items | POST | admin, nutritionist, chef, head_nurse, nurse, caregiver |

### 5.8 工具接口
| API路径 | 方法 | 权限要求 |
|---------|------|----------|
| /api/upload/excel | POST | admin, nutritionist, chef, admin_staff |
| /api/init_db | POST | admin |
| /api/init_sample_data | POST | admin |

## 6. 数据过滤实现

### 6.1 客户数据过滤
当客户角色访问客户相关接口时，系统会自动过滤数据，只返回与当前客户ID相关的数据。

### 6.2 订单数据过滤
当客户角色访问订单相关接口时，系统会自动过滤数据，只返回与当前客户ID相关的订单数据。

### 6.3 排餐数据过滤
当客户角色访问排餐相关接口时，系统会自动过滤数据，只返回与当前客户ID相关的排餐数据。

### 6.4 报表数据过滤
当客户角色访问报表相关接口时，系统会自动过滤数据，只生成与当前客户ID相关的报表数据。

## 7. 权限验证实现

### 7.1 后端权限验证
- 使用JWT令牌进行身份验证
- 使用装饰器进行权限检查
- 在API接口中实现数据访问控制

### 7.2 前端权限控制
- 根据用户角色动态生成菜单
- 根据用户权限控制按钮显示
- 实现前端路由守卫，防止未授权访问

### 7.3 数据库权限控制
- 实现数据库行级权限控制
- 为不同角色设置不同的数据库访问权限

## 8. 安全措施

### 8.1 防止越权访问
- 实现细粒度的权限控制
- 对所有API请求进行权限验证
- 对数据访问进行严格的权限检查

### 8.2 防止数据泄露
- 对敏感数据进行加密存储
- 实现数据访问日志记录
- 定期进行安全审计

### 8.3 防止暴力攻击
- 实现登录失败次数限制
- 添加请求速率限制
- 使用验证码防止自动化攻击

## 9. 权限管理最佳实践

1. **最小权限原则**：只授予用户完成其工作所需的最小权限
2. **权限分离**：不同职责的用户分配不同的权限
3. **定期审查**：定期审查用户权限，及时回收不必要的权限
4. **权限继承**：使用角色继承简化权限管理
5. **权限审计**：记录权限变更和权限使用情况

## 10. 故障排除

### 10.1 常见权限问题
| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 无法访问某个页面 | 权限不足 | 检查用户角色和权限设置 |
| 无法执行某个操作 | 操作权限不足 | 检查用户角色的操作权限 |
| 看不到某些数据 | 数据访问权限不足 | 检查用户角色的数据访问权限 |
| 前端菜单不显示 | 角色菜单配置错误 | 检查前端菜单配置 |

### 10.2 权限调试
- 查看JWT令牌中的权限信息
- 检查后端权限验证日志
- 测试API接口的权限控制
- 检查前端权限控制逻辑

## 11. 总结

餐食管理系统通过完善的权限管理体系，确保不同角色的用户只能访问和操作其权限范围内的功能和数据，有效保护了系统数据的安全性和完整性。同时，系统提供了灵活的权限配置机制，满足了不同业务场景的需求。

权限管理是系统安全的重要组成部分，需要定期审查和更新，以适应业务发展和安全需求的变化。